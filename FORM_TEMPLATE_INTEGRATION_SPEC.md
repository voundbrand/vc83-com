# Form Template Integration Specification
## Multi-Step Checkout Enhancement

**Date:** 2025-10-18
**Status:** Research & Planning Phase
**Goal:** Inject custom form template step into checkout flow WITHOUT replacing customer-info step

---

## üìã Current State Analysis

### Current Checkout Flow (6 Steps)

```
Step 1: Product Selection
  ‚Üì
Step 2: Customer Information (ALWAYS SHOWN)
  - Email (required)
  - Name (required)
  - Phone (optional)
  - Notes (optional)
  - B2B fields (company, VAT, billing address)
  ‚Üì
Step 2.5: Registration Form (CONDITIONAL - REPLACES Step 2)
  - Only if product has formId + formTiming="duringCheckout"
  - Currently SKIPS customer-info step
  - Collects form-specific data per ticket
  ‚Üì
Step 3: Payment Method Selection (CONDITIONAL)
  - Only if multiple payment providers
  ‚Üì
Step 4: Payment Form
  - Provider-specific payment UI
  ‚Üì
Step 5: Confirmation
  - Success page with tickets/receipt
```

### Current Problem

**File:** `src/components/checkout/multi-step-checkout.tsx:187-194`

```typescript
// Current logic SKIPS customer-info if form exists
if (needsForm) {
  return "registration-form"; // ‚ùå Goes directly to form
}
return "customer-info"; // ‚úÖ Only shown if NO form
```

**Issue:** When a product has a form template (like HaffSymposium), the checkout:
- ‚úÖ Shows product selection
- ‚ùå SKIPS customer-info step entirely
- ‚úÖ Goes straight to registration form
- ‚ùå Loses valuable B2B data collection (company, VAT, billing address)

---

## üéØ Desired State

### New Checkout Flow (7 Steps - Injected Approach)

```
Step 1: Product Selection
  ‚Üì
Step 2: Customer Information (ALWAYS SHOWN)
  - Email, Name, Phone, Notes
  - B2B: Company, VAT, Billing Address
  - This step is NEVER skipped
  ‚Üì
Step 2.5: Custom Form Template (CONDITIONAL - INJECTED AFTER Step 2)
  - Only if product has formId + formTiming="duringCheckout"
  - Uses HaffSymposium or other custom form templates
  - Collects event-specific data (categories, accommodations, activities)
  - Per-ticket data collection
  ‚Üì
Step 3: Payment Method Selection (CONDITIONAL)
  ‚Üì
Step 4: Payment Form
  ‚Üì
Step 5: Confirmation
```

### Key Requirements

1. **Customer-info ALWAYS runs first**
   - Never skip this step
   - Collect essential customer + B2B data
   - Store in checkout session

2. **Form template INJECTED after customer-info**
   - Only if product has form template linked
   - Appears as additional step
   - Enhances data, doesn't replace it

3. **Data flows through both steps**
   - Customer-info ‚Üí Basic contact + B2B
   - Form template ‚Üí Event-specific details
   - Both stored in checkout session

---

## üèóÔ∏è Technical Implementation Strategy

### A. Step Flow Modification

**Current Logic (multi-step-checkout.tsx:158-195):**
```typescript
case "product-selection": {
  const needsForm = /* check for formId */;

  if (needsForm) {
    return "registration-form"; // ‚ùå Skip customer-info
  }
  return "customer-info";
}

case "customer-info":
  return paymentProviders.length > 1 ? "payment-method" : "payment-form";

case "registration-form":
  return paymentProviders.length > 1 ? "payment-method" : "payment-form";
```

**Proposed New Logic:**
```typescript
case "product-selection": {
  return "customer-info"; // ‚úÖ ALWAYS go to customer-info first
}

case "customer-info": {
  // Check if any product needs form template
  const needsForm = stepData.selectedProducts?.some((sp) => {
    const product = linkedProducts.find((p) => p._id === sp.productId);
    return (
      product?.customProperties?.formId &&
      product?.customProperties?.formTiming === "duringCheckout"
    );
  });

  if (needsForm) {
    return "registration-form"; // ‚úÖ Inject form step AFTER customer-info
  }

  return paymentProviders.length > 1 ? "payment-method" : "payment-form";
}

case "registration-form":
  return paymentProviders.length > 1 ? "payment-method" : "payment-form";
```

### B. Data Structure Changes

**Current CheckoutStepData (multi-step-checkout.tsx:31-96):**
```typescript
export interface CheckoutStepData {
  // Step 2: Customer Information
  customerInfo?: {
    email: string;
    name: string;
    phone?: string;
    notes?: string;
    transactionType?: "B2C" | "B2B";
    companyName?: string;
    vatNumber?: string;
    billingAddress?: { /* ... */ };
  };

  // Step 2.5: Registration Form
  formResponses?: Array<{
    productId: Id<"objects">;
    ticketNumber: number;
    formId: string;
    responses: Record<string, unknown>;
    addedCosts: number;
    submittedAt: number;
  }>;
}
```

**No changes needed!** ‚úÖ Both data structures already exist separately.

### C. Step Progress Indicator

**Current Progress Bar (multi-step-checkout.tsx:494-525):**
```typescript
const visibleSteps = [
  { key: "product-selection", label: "Products", visible: true },
  { key: "customer-info", label: "Information", visible: true },
  {
    key: "registration-form",
    label: "Registration",
    visible: (stepData.formResponses?.length > 0) || currentStep === "registration-form",
  },
  // ...
];
```

**Issue:** Progress indicator currently shows registration-form as REPLACING customer-info.

**Proposed Change:**
```typescript
const visibleSteps = [
  { key: "product-selection", label: "Products", visible: true },
  { key: "customer-info", label: "Information", visible: true }, // ‚úÖ Always visible
  {
    key: "registration-form",
    label: "Event Details", // Better label
    visible: hasFormTemplate || currentStep === "registration-form",
  },
  // ...
];
```

### D. Back Navigation

**Current Behavior:**
- From registration-form ‚Üí back to product-selection ‚ùå

**Desired Behavior:**
- From registration-form ‚Üí back to customer-info ‚úÖ

**Change in RegistrationFormStep (registration-form-step.tsx:51):**
```typescript
// Already has onBack prop - just needs proper wiring
export function RegistrationFormStep({
  // ...
  onBack, // ‚úÖ This should navigate to customer-info now
}: RegistrationFormStepProps) {
```

---

## üìä HaffSymposium Form Analysis

### Form Structure

**File:** `src/templates/forms/haffsymposium-registration/schema.ts`

**Sections:**
1. **Category Selection** (attendee type: external, AMEOS employee, HaffNet member, speaker, sponsor, organizer)
2. **Personal Info** (salutation, title, first/last name, phone, email, organization)
3. **Arrival Times** (Friday/Saturday arrival)
4. **Accommodation** (hotel room, sharing preferences)
5. **Event Activities** (Friday activities, Saturday activities, meals)
6. **Dietary Requirements**
7. **Additional Info** (special requests, privacy consent)

### Data Collection Strategy

**Customer-info step collects:**
- ‚úÖ Email
- ‚úÖ Full name
- ‚úÖ Phone
- ‚úÖ Company (for B2B)
- ‚úÖ VAT number
- ‚úÖ Billing address

**HaffSymposium form collects:**
- ‚úÖ Attendee category (external/employee/partner/speaker/sponsor/orga)
- ‚úÖ Title (Dr., Prof., etc.)
- ‚úÖ Arrival times
- ‚úÖ Accommodation preferences
- ‚úÖ Activity selections
- ‚úÖ Dietary requirements
- ‚úÖ Special requests

**Overlap:** Email and name appear in BOTH steps!

### Handling Overlapping Fields

**Option 1: Pre-populate form from customer-info** ‚úÖ RECOMMENDED
```typescript
// In RegistrationFormStep, pre-fill email/name from stepData.customerInfo
const initialFormData = {
  private_email: stepData.customerInfo?.email,
  first_name: extractFirstName(stepData.customerInfo?.name),
  last_name: extractLastName(stepData.customerInfo?.name),
  mobile_phone: stepData.customerInfo?.phone,
};
```

**Option 2: Hide duplicate fields in form**
- Modify form renderer to skip email/name fields
- Use values from customer-info automatically

**Recommendation:** Option 1 - Pre-populate but allow editing for flexibility.

---

## üîÑ Implementation Phases

### Phase 1: Step Flow Refactor ‚úÖ SAFE
**Goal:** Make customer-info always run first

**Files to modify:**
- `src/components/checkout/multi-step-checkout.tsx`
  - Update `getNextStep()` logic (lines 158-195)
  - Ensure customer-info ‚Üí registration-form flow

**Testing:**
- ‚úÖ Products without forms ‚Üí customer-info ‚Üí payment
- ‚úÖ Products with forms ‚Üí customer-info ‚Üí registration-form ‚Üí payment
- ‚úÖ Back navigation works correctly

### Phase 2: Data Pre-population ‚úÖ ENHANCEMENT
**Goal:** Pre-fill form template with customer-info data

**Files to modify:**
- `src/components/checkout/steps/registration-form-step.tsx`
  - Accept `customerInfo` prop
  - Pre-populate overlapping fields

**Testing:**
- ‚úÖ Email/name auto-filled in form
- ‚úÖ User can edit pre-filled values
- ‚úÖ Form validation still works

### Phase 3: Progress Indicator Polish ‚úÖ UX
**Goal:** Better labels and visibility

**Files to modify:**
- `src/components/checkout/multi-step-checkout.tsx`
  - Update progress bar labels
  - Ensure both steps show in sequence

**Testing:**
- ‚úÖ Progress indicator shows both steps
- ‚úÖ Labels are clear ("Information" ‚Üí "Event Details")

---

## ‚ö†Ô∏è Risks & Considerations

### 1. Breaking Changes
**Risk:** Existing checkouts in progress might break
**Mitigation:** Deploy during low-traffic period, test thoroughly

### 2. Data Duplication
**Risk:** Email/name collected twice
**Mitigation:** Pre-populate form to reduce friction

### 3. Step Length
**Risk:** Checkout feels too long with extra step
**Mitigation:** Progress bar shows clear advancement

### 4. Mobile UX
**Risk:** Long forms on mobile are painful
**Mitigation:** Ensure responsive design, test on devices

---

## ‚úÖ Success Criteria

1. **Customer-info ALWAYS runs** - Never skipped
2. **B2B data collected** - Company, VAT, billing address captured
3. **Form template works** - HaffSymposium form displays correctly
4. **Data flows correctly** - Both steps save to checkout session
5. **No regression** - Simple products (no form) still work
6. **Back navigation** - Can go back from form to customer-info

---

## üìù Next Steps (Implementation)

1. ‚úÖ Get approval on this specification
2. üî® Implement Phase 1 (Step flow refactor)
3. üî® Test Phase 1 thoroughly
4. üî® Implement Phase 2 (Data pre-population)
5. üî® Implement Phase 3 (Progress polish)
6. üß™ End-to-end testing with real products
7. üöÄ Deploy to production

---

## üìö Related Files

- `src/components/checkout/multi-step-checkout.tsx` - Main checkout orchestrator
- `src/components/checkout/steps/customer-info-step.tsx` - Step 2 component
- `src/components/checkout/steps/registration-form-step.tsx` - Step 2.5 component
- `src/templates/forms/haffsymposium-registration/schema.ts` - Form template
- `convex/checkoutSessionOntology.ts` - Backend session management

---

**Status:** ‚úÖ Research Complete - Ready for Implementation Review
