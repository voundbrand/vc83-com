# F4 Team Harness Handoff Continuity

## Purpose

Define the canonical PM -> specialist handoff flow and the payload contract used to preserve continuity across agent turns.

## Runtime entry points

1. `tag_in_specialist` tool in `convex/ai/tools/teamTools.ts`
2. `executeTeamHandoff` mutation in `convex/ai/teamHarness.ts`
3. Specialist prompt assembly in `convex/ai/agentExecution.ts`

## Canonical handoff payload

All new handoffs use this contract:

```ts
{
  reason: string;  // Why the PM is handing off
  summary: string; // Continuity summary for the specialist
  goal: string;    // Specific objective for the specialist
}
```

Validation and compatibility rules:

- `tag_in_specialist` requires `reason`, `summary`, and `goal`.
- Legacy `contextNote` is accepted as a compatibility alias for `summary`.
- `executeTeamHandoff` normalizes historical handoff entries to include `summary` and `goal`.
- Legacy `contextSummary` remains stored for backward-compatible prompt reads.

## Session state updates

`teamSession` updates on each successful handoff:

- `activeAgentId` switches to specialist agent.
- `handoffHistory` appends normalized entry (`reason`, `summary`, `goal`, `contextSummary`, `timestamp`).
- `sharedContext` is set to `summary`.
- `conversationGoal` is set to `goal`.
- `handoffNotes` stores the canonical payload.

## Specialist continuity prompt contract

When the tagged specialist runs, prompt context includes:

- handoff source agent
- `Reason: ...`
- `Summary: ...` (fallback from legacy `contextSummary` when needed)
- `Goal: ...`
- shared notes

This is generated by `buildAgentSystemPrompt` in `convex/ai/agentExecution.ts`.
