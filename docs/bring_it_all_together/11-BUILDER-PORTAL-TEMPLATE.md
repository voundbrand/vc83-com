# 11 — Builder-Generated Client Portal

> The client portal is not a page inside our platform — it's a real Next.js app generated by the builder, connected to our API, and deployed to Vercel with a custom domain. The agency owner designs it, the builder wires it, and the plumber gets `portal.agency-name.com`.
>
> **UPDATE 2026-02-03:** Portal generation can happen in the **same builder session** as agent setup. When the builder is in "setup mode" and finishes generating agent config + KB docs, it offers: "Want me to build a client portal too?" — generating portal pages in the same session. See [09-GUIDED-SETUP-WIZARD.md](09-GUIDED-SETUP-WIZARD.md).

**Date:** 2026-02-02
**Depends on:** Builder Connect (Phase A done), Publish Pipeline (done), Sub-org model (Phase 4.1)
**Prototype:** `docs/reference_projects/bring_it_all_together_assets/white-label-customer-portal/freelancer-portal-build/`

---

## Why Builder-Generated (Not Built-In)

The original Phase 4 plan ([07-WHITE-LABEL-PORTAL.md](07-WHITE-LABEL-PORTAL.md)) assumed the client portal would be pages inside the l4yercak3 platform. That's wrong for three reasons:

1. **Custom domains** — The plumber expects `portal.schmidt-sanitaer.de`, not `app.l4yercak3.com/orgs/abc/portal`. A real deployed app on Vercel gets custom domains for free.
2. **Agency differentiation** — Every agency wants their portal to look different. The builder lets them customize layout, sections, branding — then publish.
3. **We already built this** — The builder + connect + scaffold + deploy pipeline exists. The portal is just another builder template.

The client portal becomes a **builder template** — a pre-built V0 scaffold that the agency customizes and deploys per client.

---

## The Prototype

We have a complete V0-generated portal at `docs/reference_projects/bring_it_all_together_assets/white-label-customer-portal/freelancer-portal-build/`. It includes:

| Page | Component | What It Shows |
|------|-----------|--------------|
| `/login` | `login-form.tsx` | Email + password login |
| `/register` | `register-form.tsx` | Account creation |
| `/dashboard` | `dashboard-content.tsx` | Stats cards (active projects, total invoiced, next deadline), project cards, recent invoices |
| `/dashboard/projects` | `project-view.tsx` | Project list with milestones, activity feed, files, communication dialog |
| `/dashboard/invoices` | `invoices-content.tsx` | Filterable invoice table (paid/pending/overdue), detail modal, PDF download |
| `/dashboard/messages` | — | Placeholder ("coming soon") — this becomes the conversations view |
| `/dashboard/settings` | `settings-content.tsx` | 4 tabs: Profile, Business, Billing, Notifications |

**Sidebar:** Dashboard, Projects, Invoices, Messages, Settings (via `app-sidebar.tsx`)

All built with shadcn/ui components on Next.js App Router. Production-quality UI.

---

## Architecture: How It Works

```
AGENCY OWNER (in l4yercak3 builder)
    │
    ├── 1. "New App" → selects "Client Portal" template
    │       Builder loads the portal scaffold into v0 chat
    │       Agency customizes: branding, sections, layout
    │
    ├── 2. "Connect" tab → auto-detects data needs
    │       ✓ Invoices (invoices table in dashboard)
    │       ✓ CRM/Contacts (contacts page)
    │       ✓ Bookings (calendar/appointments)
    │       ✓ Conversations (messages page) ← NEW API CATEGORY
    │       Agency links to sub-org's real backend records
    │
    ├── 3. "Publish" → scaffold generator adds typed API helpers
    │       lib/invoices.ts, lib/crm.ts, lib/bookings.ts, lib/conversations.ts
    │       .env with API key scoped to sub-org
    │       GitHub push → Vercel deploy
    │
    └── 4. Live at client-name.agency-brand.com
            Plumber logs in, sees real conversations + bookings + invoices
            Agency owner has multi-tenant switcher to manage all client portals
```

### Data Flow (Deployed Portal → l4yercak3 Backend)

```
Portal App (Vercel)                    l4yercak3 Backend (Convex)
─────────────────                      ──────────────────────────

lib/conversations.ts ──GET /api/v1/conversations──→ agentSessions query
                                                     (scoped to sub-org)

lib/invoices.ts ──────GET /api/v1/invoices────────→ invoiceOntology query
                                                     (scoped to sub-org)

lib/crm.ts ───────────GET /api/v1/crm/contacts───→ crmOntology query
                                                     (scoped to sub-org)

lib/bookings.ts ──────GET /api/v1/resource-bookings→ bookingOntology query
                                                     (scoped to sub-org)

Auth: API key (sk_live_...) scoped to sub-org
      OR OAuth JWT with sub_org claim for agency multi-tenant
```

---

## New: Conversations API Category (10th Ontology Type)

The current 9 API categories don't include agent conversations. The portal's Messages page needs:

### Endpoints

| Method | Path | Purpose |
|--------|------|---------|
| `GET` | `/api/v1/conversations` | List agent sessions for this org. Filter by status, channel, date range |
| `GET` | `/api/v1/conversations/:sessionId` | Get session detail (metadata, status, channel, contact) |
| `GET` | `/api/v1/conversations/:sessionId/messages` | Get message history for a session |
| `POST` | `/api/v1/conversations/:sessionId/messages` | Send message as human (takeover). Triggers `processInboundMessage` with `source: "human_takeover"` |
| `PATCH` | `/api/v1/conversations/:sessionId` | Update session status (e.g., close, hand off, reactivate) |

### Scopes

- `conversations:read` — list sessions + messages
- `conversations:write` — send messages (human takeover), update status

### Backend Implementation

**New file:** `convex/api/v1/conversations.ts`

Queries wrap existing internals:
- `agentSessions.ts:getSessionsByOrg` → list sessions
- `agentSessions.ts:getSessionMessages` → message history
- `agentExecution.ts:processInboundMessage` → human message injection

**HTTP routes to add in `convex/http.ts`:**
```
GET  /api/v1/conversations
GET  /api/v1/conversations/:sessionId
GET  /api/v1/conversations/:sessionId/messages
POST /api/v1/conversations/:sessionId/messages
PATCH /api/v1/conversations/:sessionId
```

### Builder Integration

- Add `conversations` to `src/lib/api-catalog.ts` (10th category)
- Add detection in `v0-file-analyzer.ts`: chat/message/conversation keywords
- Add `lib/conversations.ts` to scaffold generator in `thin-client.ts`
- Connection panel: auto-detect messages page → link to agent

---

## New: Agency Multi-Tenant Switcher

The agency owner manages multiple client portals. Two approaches:

### Option A: One Portal Per Client (Recommended)

Each client gets their own deployed portal with its own API key scoped to the sub-org. The agency owner:
- Sees all portals from their l4yercak3 dashboard (existing agency dashboard concept)
- Opens any client's portal URL to see what the client sees
- Authenticates via OAuth JWT (not API key) which carries `sub_org` claim
- Switcher in the portal header: dropdown of all sub-orgs under this agency

**Auth flow for agency owner:**
1. Agency owner visits `portal.schmidt-sanitaer.de`
2. Clicks "Login as Agency Admin"
3. OAuth redirect to l4yercak3 → gets JWT with `org: agency_id, sub_org: schmidt_id`
4. Portal reads `sub_org` claim → fetches data for Schmidt Sanitär
5. Switcher in header lists all sub-orgs for this agency → switching updates `sub_org` in JWT

**Auth flow for client (plumber):**
1. Plumber visits `portal.schmidt-sanitaer.de`
2. Logs in with magic link (existing project drawer auth pattern)
3. Session scoped to Schmidt Sanitär sub-org
4. No switcher — plumber only sees their own data

### Option B: Single Agency Portal (Alternative)

One portal URL (`portal.agency-name.com`) with client switching. Agency owner logs in, sees all clients. Client logs in, sees only their org.

**Downside:** Harder to white-label per client. The plumber's URL would be `portal.agency-name.com/clients/schmidt` instead of `portal.schmidt-sanitaer.de`.

**Recommendation:** Option A. One portal per client. Each gets their own custom domain. The agency manages the fleet from the l4yercak3 dashboard.

---

## Sub-Org Model (Prerequisite)

From Phase 4.1, adapted for the builder approach:

### Schema Change

```typescript
// In organizations table (convex/schema.ts)
parentOrganizationId: v.optional(v.id("organizations")),
```

### Queries

```typescript
// convex/api/v1/organizations.ts (or new file)
getChildOrganizations({ parentOrgId }) → list sub-orgs
createChildOrganization({ parentOrgId, name, branding }) → creates sub-org
```

### What Sub-Org Gets Automatically

Because the ontology is already org-scoped:
- Its own agent(s) — created during setup wizard
- Its own CRM contacts, bookings, invoices
- Its own media library (knowledge base)
- Its own API key (generated during builder connect step)
- Its own credit allocation (from parent agency's credit pool)

### Credit Allocation

Agency buys credits at agency level. Sub-org credits are tracked separately but deducted from parent pool:

```
Agency Org: 50,000 credits/mo
├── Schmidt Sanitär: used 2,400 this month
├── Bella Salon: used 4,100 this month
├── Pizzeria Roma: used 800 this month
└── Remaining: 42,700
```

Credit transactions tagged with `organizationId` (sub-org) but balance checked against parent org.

---

## Portal Template in the Builder

### How the Agency Uses It

**Path A: During agent setup (one session)**
1. Agency clicks "New Agent" → builder opens in setup mode
2. Builder AI interviews agency owner, generates agent config + KB docs
3. Builder AI offers: "Want me to build a client portal too?"
4. If yes: generates portal pages (dashboard, messages, invoices, settings) in same session
5. **Connect step:** creates agent + saves KB docs + wires portal to sub-org data
6. **Publish:** portal deployed to Vercel, agent activated

**Path B: Standalone portal session**
1. **"New App"** in builder → template gallery shows "Client Portal"
2. Builder loads portal scaffold into v0 chat context
3. Agency customizes via chat: "Change the color scheme to dark blue", "Remove the Projects page", "Add a Bookings calendar to the dashboard"
4. V0 regenerates the React components
5. **Connect step:** auto-detects Invoices, CRM, Conversations, Bookings → links to sub-org's records
6. **Publish:** scaffold adds `lib/conversations.ts`, `lib/invoices.ts`, etc. → Vercel deploy
7. Agency adds custom domain in post-deploy settings

### Template Sections (Modular)

The portal template is a superset. Agency picks which sections to include:

| Section | Default | Component | API Category |
|---------|---------|-----------|-------------|
| Dashboard (stats) | Always | `dashboard-content.tsx` | `conversations`, `bookings`, `invoices` |
| Conversations | Always | `conversations-content.tsx` | `conversations` |
| Bookings | Optional | `bookings-content.tsx` | `bookings` |
| Invoices | Optional | `invoices-content.tsx` | `invoices` |
| Contacts/Leads | Optional | `contacts-content.tsx` | `crm` |
| Knowledge Base | Optional | `knowledge-content.tsx` | Custom (media library API) |
| Settings | Always | `settings-content.tsx` | — |

### Branding Config

Stored on the sub-org's builder app record:

```typescript
portalBranding: {
  agencyName: "Digital Agentur München",
  clientName: "Schmidt Sanitär",
  logo: "https://storage.l4yercak3.com/...",
  primaryColor: "#1e40af",
  favicon: "https://storage.l4yercak3.com/...",
  customDomain: "portal.schmidt-sanitaer.de",
}
```

Injected into the portal via environment variables or fetched from a branding API endpoint.

---

## Implementation Checklist

### Phase 4A: Sub-Org + Conversations API (Prerequisites)

- [ ] 4A.1 Add `parentOrganizationId` to organizations schema
- [ ] 4A.2 Sub-org CRUD: `createChildOrganization`, `getChildOrganizations`
- [ ] 4A.3 Credit pool sharing: sub-org deductions from parent balance
- [ ] 4A.4 Conversations API endpoints (5 routes in `convex/http.ts`)
- [ ] 4A.5 `convex/api/v1/conversations.ts` — queries wrapping agentSessions
- [ ] 4A.6 Add `conversations` to `src/lib/api-catalog.ts` (10th category)
- [ ] 4A.7 Add `conversations` scaffold to `thin-client.ts`

### Phase 4B: Portal Template in Builder

- [ ] 4B.1 Create portal template scaffold (based on prototype in `freelancer-portal-build/`)
- [ ] 4B.2 Make sections modular (dashboard always, others toggleable)
- [ ] 4B.3 Add portal template to builder template gallery
- [ ] 4B.4 Wire Messages page to conversations API (replace "coming soon")
- [ ] 4B.5 Wire Dashboard stats to real queries (conversations count, bookings, invoices)
- [ ] 4B.6 Wire Invoices page to invoices API
- [ ] 4B.7 Add Bookings page (calendar view from availability API)
- [ ] 4B.8 Add Contacts page (CRM API)
- [ ] 4B.9 Branding injection (logo, colors, names from env vars or API)

### Phase 4C: Auth + Deploy

- [ ] 4C.1 Client auth: magic link login for plumber (reuse project drawer pattern)
- [ ] 4C.2 Agency auth: OAuth JWT with `sub_org` claim
- [ ] 4C.3 Multi-tenant switcher component (agency owner only)
- [ ] 4C.4 Custom domain setup in post-deploy settings (Vercel domain API)
- [ ] 4C.5 Auto-detect conversations in v0 file analyzer

### Phase 4D: Agency Dashboard (In-Platform)

- [ ] 4D.1 All-clients view in l4yercak3 (list sub-orgs with stats)
- [ ] 4D.2 Per-client drill-down (conversations, bookings, credit usage)
- [ ] 4D.3 "New Client" flow: create sub-org → setup wizard → generate portal → deploy
- [ ] 4D.4 Client portal management (view URL, redeploy, update branding)

---

## Acceptance Criteria

**Phase 4A:** `GET /api/v1/conversations` returns agent sessions scoped to a sub-org. Sub-org created under agency org, data isolated.

**Phase 4B:** Agency opens builder → selects "Client Portal" template → customizes via v0 chat → connects to sub-org data → publishes. Portal shows real conversations from the agent.

**Phase 4C:** Plumber logs into `portal.schmidt-sanitaer.de` via magic link, sees conversations + bookings. Agency owner logs into same URL via OAuth, sees switcher for all clients.

**Phase 4D:** Agency dashboard in l4yercak3 shows all sub-orgs, stats, credit usage. "New Client" creates sub-org + agent + portal in one flow.

---

## Key Decisions

| Decision | Reason |
|----------|--------|
| Builder-generated, not built-in | Custom domains, agency differentiation, reuse existing pipeline |
| One portal per client (not one portal with client switching) | Better white-labeling, cleaner custom domains, simpler auth |
| Conversations as 10th API category | Agent sessions are first-class data — portal needs them like it needs invoices |
| Magic link for client auth | Plumber doesn't want another password. Same pattern as project drawer. |
| OAuth JWT for agency multi-tenant | Agency owner already has l4yercak3 account. JWT `sub_org` claim enables switching. |
| Credit pool from parent org | Agency buys credits once, allocates across clients. No per-sub-org billing complexity. |

---

## Related Docs

- [07-WHITE-LABEL-PORTAL.md](07-WHITE-LABEL-PORTAL.md) — Original sub-org + portal concept (superseded by this doc for portal implementation, sub-org model still applies)
- [V0 Pipeline Master Plan](../v0_to_l4yercak3_backend/MASTER_PLAN.md) — Builder connect + publish pipeline details
- [ONTOLOGY_CONNECTION_REFERENCE.md](../v0_to_l4yercak3_backend/ONTOLOGY_CONNECTION_REFERENCE.md) — 9 existing API categories
- [Prototype](../reference_projects/bring_it_all_together_assets/white-label-customer-portal/freelancer-portal-build/) — V0-generated portal scaffold
- [API Catalog](../../src/lib/api-catalog.ts) — Current 9 API categories
- [Scaffold Generator](../../src/lib/scaffold-generators/thin-client.ts) — Generates typed API helpers per category
